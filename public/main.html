<!-- public/main.html -->
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>XportMate - Asisten Ekspor Digital</title>
    <link rel="icon" type="image/svg+xml" href="https://www.svgrepo.com/download/285154/robot.svg" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark-start: #111827;
            --bg-dark-end: #374151;
            --primary-accent: #38bdf8;
            --primary-accent-hover: #7dd3fc;
            --text-light: #e5e7eb;
            --text-heading: #ffffff;
            --card-bg: rgba(31, 41, 55, 0.6);
            --border-color: rgba(255, 255, 255, 0.1);
            --input-bg: rgba(255, 255, 255, 0.05);
        }

        body {
            background: linear-gradient(135deg, var(--bg-dark-start), var(--bg-dark-end));
            color: var(--text-light);
            font-family: 'Inter', 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
        }

        .navbar {
            background-color: rgba(17, 24, 39, 0.8);
            backdrop-filter: blur(10px);
        }

        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            color: var(--text-light);
            border-radius: 15px;
        }

        .form-control,
        .form-select {
            background-color: var(--input-bg);
            border-color: var(--border-color);
            color: var(--text-heading);
            border-radius: 8px;
        }

        .form-control:focus,
        .form-select:focus {
            background-color: var(--input-bg);
            border-color: var(--primary-accent);
            color: var(--text-heading);
            box-shadow: 0 0 0 0.25rem rgba(56, 189, 248, 0.25);
        }

        input::placeholder {
          color: white !important;
          opacity: 1;
        }

        .btn-primary {
            background-color: var(--primary-accent);
            border: none;
            transition: all 0.3s ease;
            color: var(--bg-dark-start);
            font-weight: 600;
        }

        .btn-primary:hover {
            background-color: var(--primary-accent-hover);
        }

        .chat-window {
            height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            padding: 1rem;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        .chat-message {
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
        }

        .chat-message.user {
            align-items: flex-end;
        }

        .chat-message.bot {
            align-items: flex-start;
        }

        .chat-message .message-bubble {
            display: inline-block;
            padding: 0.75rem 1.2rem;
            border-radius: 18px;
            max-width: 85%;
            text-align: left;
            word-wrap: break-word;
            line-height: 1.5;
        }

        .chat-message.user .message-bubble {
            background-color: var(--primary-accent);
            color: var(--bg-dark-start);
            font-weight: 500;
        }

        .chat-message.bot .message-bubble {
            background-color: #374151;
            color: var(--text-light);
        }

        .footer {
          background-color: var(--bg-dark-start);
          color: #9ca3af;
          padding: 2rem 0;
          margin-top: 60px;
          text-align: center;
        }

        #login-view {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        .login-container {
            width: 100%;
            max-width: 450px;
            padding: 2.5rem;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .nav-tabs .nav-link {
            color: var(--text-light);
            border: none;
            border-bottom: 2px solid transparent;
        }

        .nav-tabs .nav-link.active {
            color: var(--primary-accent);
            background-color: transparent;
            border-bottom: 2px solid var(--primary-accent);
        }

        #apiKeyText {
            word-break: break-all;
        }

        .form-select option {
            background-color: var(--bg-dark-start);
            color: var(--text-light);
        }

        .custom-dark-select {
            background-color: var(--input-bg);
            color: var(--text-heading);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-size: 1rem;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg fill='%23e5e7eb' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414L10 13.414l-4.707-4.707a1 1 0 010-1.414z' clip-rule='evenodd' /%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1rem;
        }

        .custom-dark-select:focus {
            outline: none;
            box-shadow: 0 0 0 0.25rem rgba(56, 189, 248, 0.25);
            border-color: var(--primary-accent);
        }

        #ask-ai-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: var(--primary-accent);
            border: none;
            color: var(--bg-dark-start);
        }

        #ask-ai-btn:hover {
            background-color: var(--primary-accent-hover);
        }

        #result {
            background-color: rgba(0, 0, 0, 0.2);
            border-color: var(--border-color);
            color: #fff;
            border-radius: 8px;
        }

        .spinner-border {
            color: var(--primary-accent);
        }
    </style>
</head>
<body>

    <!-- Tampilan Login (Default) -->
    <div id="login-view">
        <div class="login-container">
            <h2 class="text-center mb-4">Selamat Datang</h2>
            <p class="text-center text-muted mb-4">Login atau registrasi untuk melanjutkan.</p>

            <ul class="nav nav-tabs nav-fill mb-3" id="authTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="login-tab" data-bs-toggle="tab" data-bs-target="#login-pane" type="button">
                        Login
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="register-tab" data-bs-toggle="tab" data-bs-target="#register-pane" type="button">
                        Registrasi
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="authTabsContent">
                <div class="tab-pane fade show active" id="login-pane" role="tabpanel">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="loginInput" class="form-label">Username atau Email</label>
                            <input type="text" class="form-control" id="loginInput" required autocomplete="username">
                        </div>
                        <div class="mb-3">
                            <label for="loginPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="loginPassword" required autocomplete="current-password">
                        </div>
                        <button type="submit" class="btn btn-primary w-100 mt-3">Login</button>
                    </form>
                </div>

                <div class="tab-pane fade" id="register-pane" role="tabpanel">
                    <form id="registerForm">
                        <div class="mb-3">
                            <label for="registerUsername" class="form-label">Username</label>
                            <input type="text" class="form-control" id="registerUsername" required autocomplete="username">
                        </div>
                        <div class="mb-3">
                            <label for="registerEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="registerEmail" required autocomplete="email">
                        </div>
                        <div class="mb-3">
                            <label for="registerPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="registerPassword" required autocomplete="new-password">
                        </div>
                        <button type="submit" class="btn btn-primary w-100 mt-3">Registrasi</button>
                    </form>
                </div>
            </div>

            <div id="alert-container" class="mt-3"></div>
        </div>
    </div>

    <!-- Tampilan Aplikasi Utama (Disembunyikan) -->
    <div id="app-view" class="d-none">
        <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
            <div class="container">
                <a class="navbar-brand fw-bold" href="/">
                    <i class="bi bi-robot me-2"></i> XportMate
                </a>
                <div class="ms-auto">
                    <div class="dropdown">
                        <button class="btn btn-outline-info dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle me-1"></i>
                            <span id="username-display"></span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end">
                            <li>
                                <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#accountModal">
                                    Akun & API Key
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" id="logoutBtn">Logout</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>

        <div class="container py-5">
            <div class="text-center mb-5">
                <h2 class="fw-bold display-6">Platform AIaaS untuk Keunggulan Ekspor Digital</h2>
                <p class="lead" style="color: var(--text-light);">
                    Tingkatkan daya saing global, efisiensi, dan pertumbuhan ekonomi melalui ekspor layanan digital yang didukung AI.
                </p>
            </div>

            <div class="row g-4">
                <div class="col-lg-6">
                    <div class="card h-100">
                        <div class="card-body d-flex flex-column">
                            <h4 class="card-title mb-4">1. Konsultasi dengan Asisten AI</h4>
                            <div id="chat-window" class="chat-window flex-grow-1"></div>
                            <div id="loadingChat" class="mt-2 d-none">
                                <span class="text-white"><i>Asisten sedang mengetik...</i></span>
                            </div>
                            <form id="chatForm" class="mt-3">
                                <div class="input-group">
                                    <input type="text" id="chat-input" class="form-control" placeholder="Ketik pertanyaan Anda..." required />
                                    <button class="btn btn-primary" type="submit">
                                        Kirim <i class="bi bi-send-fill ms-1"></i>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="card h-100">
                        <div class="card-body">
                            <h4 class="card-title mb-4">2. Analisis Dokumen Cerdas</h4>
                            <form id="ocrForm">
                                <div class="mb-3">
                                    <label for="lang" class="form-label">Pilih Bahasa Dokumen</label>
                                    <select id="lang" name="lang" class="form-select custom-dark-select">
                                        <option value="ind" selected>🇮🇩 Bahasa (Indonesia)</option>
                                        <option value="eng">🇬🇧 English (United Kingdom/USA)</option>
                                        <option value="chi_sim">🇨🇳 Mandarin (Simplified, China)</option>
                                        <option value="chi_tra">🇨🇳 Mandarin (Traditional, Taiwan/Hong Kong)</option>
                                        <option value="jpn">🇯🇵 Jepang (Japan)</option>
                                        <option value="kor">🇰🇷 Korea (South Korea)</option>
                                        <option value="hin">🇮🇳 Hindi (India)</option>
                                        <option value="tha">🇹🇭 Thai (Thailand)</option>
                                        <option value="rus">🇷🇺 Rusia (Russia)</option>
                                        <option value="ara">🇸🇦 Arab (Saudi Arabia)</option>
                                        <option value="fas">🇮🇷 Persia (Farsi, Iran)</option>
                                        <option value="mya">🇲🇲 Burma (Myanmar)</option>
                                        <option value="sin">🇱🇰 Sinhala (Sri Lanka)</option>
                                        <option value="ben">🇧🇩 Bengali (Bangladesh)</option>
                                        <option value="khm">🇰🇭 Khmer (Cambodia)</option>
                                        <option value="lao">🇱🇦 Lao (Laos)</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="file" class="form-label">Upload Gambar atau PDF</label>
                                    <div class="d-flex align-items-center gap-2">
                                        <input type="file" class="form-control" id="file" name="file" accept=".png,.jpg,.jpeg,.pdf" />
                                        <button type="button" id="clearFileBtn" class="btn btn-outline-danger btn-sm d-none py-2 px-3">X</button>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="file_url" class="form-label">Atau masukkan URL Gambar/PDF</label>
                                    <input type="url" class="form-control" id="file_url" name="file_url" placeholder="Contoh: https://example.com/image.jpg" />
                                </div>

                                <div class="mb-3">
                                    <label for="file_id" class="form-label">Atau masukkan Telegram File ID</label>
                                    <input type="text" class="form-control" id="file_id" name="file_id" placeholder="Contoh: AgADBAADtqwxG_..." />
                                </div>

                                <button type="submit" class="btn btn-primary w-100 py-2">Proses Dokumen</button>
                            </form>

                            <div id="loadingOcr" class="mt-4 d-none text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Processing...</span>
                                </div>
                                <p class="ms-2 mt-2">Menganalisis dokumen, mohon tunggu...</p>
                            </div>

                            <hr class="my-4" style="border-color: var(--border-color);" />

                            <h5>Hasil Analisis Teks:</h5>
                            <div id="result-container" class="position-relative">
                                <pre id="result" class="p-3 border rounded" style="white-space: pre-wrap; word-wrap: break-word; min-height: 100px;"></pre>
                                <button id="ask-ai-btn" class="btn btn-sm d-none position-absolute top-0 end-0 mt-2 me-2" title="Diskusikan dengan Asisten Virtual">
                                    <i class="bi bi-robot fs-5"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="footer">
            <div class="container">
                <p>&copy; 2025 AIaaS Ekspor Digital. Seluruh Hak Cipta Dilindungi.</p>
            </div>
        </footer>
    </div>

    <!-- Modal Akun -->
    <div class="modal fade" id="accountModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-light">
          <div class="modal-header border-secondary">
            <h5 class="modal-title">Info Akun</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p><strong>Username:</strong> <span id="modalUsername"></span></p>
            <p><strong>Email:</strong> <span id="modalEmail"></span></p>
            <p class="mb-2"><strong>API Key:</strong></p>
            <div class="p-3 rounded mb-3" style="background-color: var(--input-bg);">
              <p id="apiKeyText" class="text-info mb-2"></p>
              <button id="copyApiKeyBtn" class="btn btn-sm btn-outline-info">
                <i class="bi bi-clipboard"></i> Salin
              </button>
              <span id="copy-feedback" class="ms-2 d-none text-info">Disalin!</span>
            </div>

            <hr class="border-secondary my-3" />

            <div class="small">
              <p><strong>📘 Cara Menggunakan API:</strong></p>

              <p><strong>🌐 Base URL:</strong><br>
                <code class="text-light">https://hackathon-fekdi.azurewebsites.net</code>
              </p>

              <p class="mb-1"><strong>🔹 OCR Endpoint</strong></p>
              <ul>
                <li>Endpoint: <code class="text-light">/api/ocr</code></li>
                <li>Method: <code class="text-light">POST</code></li>
                <li>Header: <code class="text-light">x-api-key: &lt;API_KEY_ANDA&gt;</code></li>
                <li>Body:
                  <ul>
                    <li><code>file</code> (form-data) <em>atau</em></li>
                    <li><code>file_url</code> atau <code>file_id</code> (JSON)</li>
                  </ul>
                </li>
              </ul>

              <p class="mb-1 mt-3"><strong>🔹 Chat Endpoint</strong></p>
              <ul>
                <li>Endpoint: <code class="text-light">/api/chat</code></li>
                <li>Method: <code class="text-light">POST</code></li>
                <li>Header: <code class="text-light">x-api-key: &lt;API_KEY_ANDA&gt;</code></li>
                <li>Body (JSON):
                  <ul>
                    <li><code>sessionId</code>: ID sesi pengguna</li>
                    <li><code>message</code>: Pertanyaan atau perintah Anda</li>
                  </ul>
                </li>
              </ul>

              <p class="text-white">Cocok digunakan pada Postman, n8n, atau aplikasi Anda sendiri.</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- SCRIPT FUNGSIONALITAS (DISESUAIKAN) ---

        // Fungsi utama untuk memeriksa status login dan menampilkan tampilan yang sesuai
        function initializeApp() {
            const token = sessionStorage.getItem('token');
            if (token) {
                document.getElementById('login-view').classList.add('d-none');
                document.getElementById('app-view').classList.remove('d-none');
                setupApplication(token);
            } else {
                document.getElementById('login-view').classList.remove('d-none');
                document.getElementById('app-view').classList.add('d-none');
                setupAuthForms();
            }
        }

        // Menyiapkan event listener untuk form login dan registrasi
        function setupAuthForms() {
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const login = document.getElementById('loginInput').value;
                const password = document.getElementById('loginPassword').value;
                try {
                    const response = await fetch('/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ login, password }),
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message || 'Login gagal');
                    sessionStorage.setItem('token', data.token);
                    initializeApp();
                } catch (error) {
                    showAlert(error.message);
                }
            });

            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = document.getElementById('registerUsername').value;
                const email = document.getElementById('registerEmail').value;
                const password = document.getElementById('registerPassword').value;
                try {
                    const response = await fetch('/register', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, email, password }),
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message || 'Registrasi gagal');
                    showAlert('Registrasi berhasil! Silakan login.', 'success');
                    new bootstrap.Tab(document.getElementById('login-tab')).show();
                    document.getElementById('loginInput').value = username;
                    document.getElementById('loginPassword').value = '';
                } catch (error) {
                    showAlert(error.message);
                }
            });
        }
        
        // Fungsi untuk menampilkan notifikasi
        function showAlert(message, type = 'danger') {
          const alertContainer = document.getElementById('alert-container');
          alertContainer.innerHTML = `
            <div class="alert alert-${type} alert-dismissible" role="alert">
              ${message}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>`;
        }

        // Menyiapkan semua fungsionalitas aplikasi setelah login berhasil
        function setupApplication(token) {
            const authHeader = { 'Authorization': `Bearer ${token}` };
            let sessionId = sessionStorage.getItem('sessionId') || `session_${Date.now()}`;
            sessionStorage.setItem('sessionId', sessionId);

            // --- Variabel Global & Inisialisasi Fitur ---
            const ocrForm = document.getElementById("ocrForm");
            const loadingOcr = document.getElementById("loadingOcr");
            const resultBox = document.getElementById("result");
            const askAiBtn = document.getElementById("ask-ai-btn");
            
            const chatForm = document.getElementById("chatForm");
            const chatInput = document.getElementById("chat-input");
            const chatWindow = document.getElementById("chat-window");
            const loadingChat = document.getElementById("loadingChat");

            // --- Fungsi Akun & Logout ---
            async function fetchAccountInfo() {
                try {
                    const response = await fetch('/api/me', { headers: authHeader });
                    if (!response.ok) { if (res.status === 401 || res.status === 403) logout(); return; }
                    const user = await response.json();
                    document.getElementById('username-display').textContent = user.username;
                    document.getElementById('modalUsername').textContent = user.username;
                    document.getElementById('modalEmail').textContent = user.email;
                    document.getElementById('apiKeyText').textContent = user.apiKey;
                } catch (error) { logout(); }
            }

            function logout() {
                sessionStorage.removeItem('token');
                sessionStorage.removeItem('sessionId');
                initializeApp();
            }
            document.getElementById("logoutBtn").addEventListener('click', logout);
            
            document.getElementById('copyApiKeyBtn').addEventListener('click', () => {
                navigator.clipboard.writeText(document.getElementById('apiKeyText').textContent);
                const feedback = document.getElementById('copy-feedback');
                feedback.classList.remove('d-none');
                setTimeout(() => feedback.classList.add('d-none'), 2000);
            });

            // --- Logika Chatbot ---
            function addMessageToChat(message, sender) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${sender}`;
                const bubbleDiv = document.createElement('div');
                bubbleDiv.className = 'message-bubble';
                if (sender === 'bot') { bubbleDiv.innerHTML = marked.parse(message); } 
                else { bubbleDiv.textContent = message; }
                messageDiv.appendChild(bubbleDiv);
                chatWindow.appendChild(messageDiv);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }
            
            chatForm.addEventListener("submit", async (e) => {
              e.preventDefault();
              const message = chatInput.value.trim();
              if (!message) return;

              addMessageToChat(message, 'user');
              chatInput.value = "";
              loadingChat.classList.remove('d-none');

              try {
                const response = await fetch('/chat', {
                  method: 'POST',
                  headers: {
                    ...authHeader,
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({ sessionId, message })
                });

                if (!response.ok) {
                  const errorData = await response.json();
                  throw new Error(errorData.error || `HTTP Error: ${response.status}`);
                }

                const data = await response.json();
                addMessageToChat(data.reply, 'bot');

              } catch (err) {
                addMessageToChat(`Maaf, terjadi kesalahan: ${err.message}`, 'bot');
              } finally {
                loadingChat.classList.add('d-none');
              }
            });

            // --- Logika Analisis Dokumen ---
            ocrForm.addEventListener("submit", async function (e) {
                e.preventDefault();
                const formData = new FormData(ocrForm);
                if (!formData.get('file')?.size && !formData.get('file_url') && !formData.get('file_id')) {
                    resultBox.textContent = "Peringatan: Harap pilih file, masukkan File ID, atau URL.";
                    return;
                }
                resultBox.textContent = "";
                askAiBtn.classList.add("d-none");
                loadingOcr.classList.remove("d-none");

                let requestBody;
                let requestHeaders = { ...authHeader };

                if (!formData.get('file')?.size) {
                    requestBody = JSON.stringify(Object.fromEntries(formData));
                    requestHeaders["Content-Type"] = "application/json";
                } else {
                    requestBody = formData;
                }

                try {
                  const response = await fetch("/ocr", {
                    method: "POST",
                    headers: requestHeaders,
                    body: requestBody
                  });

                  let responseData;
                  try {
                    responseData = await response.json();
                  } catch (parseError) {
                    responseData = { error: "Response bukan JSON valid dari server." };
                  }

                  if (!response.ok) {
                    throw new Error(responseData.error || `HTTP error! status: ${response.status}`);
                  }

                  resultBox.textContent = responseData.text || "Tidak ada teks yang terdeteksi.";
                  if (responseData.text) {
                    askAiBtn.classList.remove("d-none");
                  }

                } catch (err) {
                  resultBox.textContent = err.message;
                } finally {
                  loadingOcr.classList.add("d-none");
                  e.target.reset();
                  handleInputLocking();
                }
            });

            // --- Logika UI Tambahan (dari file asli) ---
            const fileInput = document.getElementById("file");
            const fileUrlInput = document.getElementById("file_url");
            const fileIdInput = document.getElementById("file_id");
            const clearFileBtn = document.getElementById("clearFileBtn");

            function handleInputLocking() {
                const hasFile = fileInput.files.length > 0;
                const hasUrl = fileUrlInput.value.trim() !== "";
                const hasId = fileIdInput.value.trim() !== "";
                clearFileBtn.classList.toggle("d-none", !hasFile);
                fileUrlInput.disabled = hasFile || hasId;
                fileIdInput.disabled = hasFile || hasUrl;
                fileInput.disabled = hasUrl || hasId;
            }

            fileInput.addEventListener("change", handleInputLocking);
            fileUrlInput.addEventListener("input", handleInputLocking);
            fileIdInput.addEventListener("input", handleInputLocking);
            clearFileBtn.addEventListener("click", () => { fileInput.value = ""; handleInputLocking(); });

            askAiBtn.addEventListener("click", async () => {
                const ocrResult = resultBox.textContent.trim();
                if (ocrResult && ocrResult !== "Tidak ada teks yang terdeteksi.") {
                    const prompt = `Berikut adalah teks hasil analisis dari sebuah dokumen. Tolong berikan ringkasan atau poin-poin penting dari teks ini:\n\n${ocrResult}`;
                    addMessageToChat(prompt, 'user');
                    loadingChat.classList.remove('d-none');
                    try {
                        const response = await fetch('/chat', {
                            method: 'POST',
                            headers: { ...authHeader, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ sessionId, message: prompt })
                        });
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error || `HTTP Error: ${response.status}`);
                        }
                        const data = await response.json();
                        addMessageToChat(data.reply, 'bot');
                    } catch (err) {
                        addMessageToChat(`Maaf, terjadi kesalahan: ${err.message}`, 'bot');
                    } finally {
                        loadingChat.classList.add('d-none');
                    }
                    document.getElementById('chat-input').focus();
                }
            });
            
            // --- Inisialisasi Aplikasi ---
            fetchAccountInfo();
            // Hanya tampilkan pesan pembuka jika belum ada pesan di chat window
            if(chatWindow.children.length === 0) {
                addMessageToChat("Selamat datang kembali! Saya adalah asisten AI Anda. Silakan mulai dengan mengajukan pertanyaan atau menganalisis dokumen.", 'bot');
            }
        }

        // Jalankan aplikasi saat halaman selesai dimuat
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
